# Отчет по лабораторной работе №4


---

## Цели работы

1. Получить навыки проектирования и документирования API
2. Получить навыки создания окружения на основе технологии контейнеризации Docker
3. Разработать модель требований и реестр вариантов использования
4. Спроектировать физическую модель базы данных
5. Спроектировать маршруты и конечные точки API
6. Создать спецификацию OpenAPI с примерами запросов

---

## Задание 1. Проектирование модели требований и реестра вариантов использования

### Описание

На основе требований из лабораторной работы №3 была разработана полная модель требований в формате:

**Действующее лицо → User Story → Use Case**

### Выполненные работы

1. **Идентифицированы действующие лица:**

   - Гость (Guest)
   - Покупатель (Customer)
   - Администратор (Admin)
   - Менеджер (Manager)
   - Курьер (Courier)
2. **Разработаны User Stories для каждого актера:**

   - Для Гостя: 3 User Stories (Поиск товаров, Просмотр отзывов, Регистрация)
   - Для Покупателя: 7 User Stories (Управление корзиной, Оформление заказа, и др.)
   - Для Администратора: 6 User Stories (Управление каталогом, пользователями, и др.)
   - Для Менеджера: 3 User Stories (Обработка заказов, модерация, аналитика)
   - Для Курьера: 2 User Stories (Отслеживание и подтверждение доставок)
3. **Сопоставлены User Stories с Use Cases:**

   - Всего 24 Use Case из лабораторной работы №3
   - Каждая User Story связана с одним или несколькими Use Cases
   - Для каждого Use Case определены Acceptance Criteria
4. **Создан реестр вариантов использования:**

   - Таблица соответствия ID → Актер → User Story → Use Case
   - Приоритизация по методу MoSCoW (Must Have, Should Have, Could Have, Won't Have)
   - Детальное описание каждого Use Case с основными и альтернативными потоками

### Результаты

**Созданные документы:**

- `requirements-model.md` - Полная модель требований с User Stories
- `use-case-registry.md` - Реестр вариантов использования с детальным описанием

**Ключевые метрики:**

- 5 действующих лиц
- 21 User Story
- 24 Use Case
- 8 Must Have требований
- 11 Should Have требований
- 5 Could Have требований

### Приоритизация требований

| Категория | Количество | Use Cases                         |
| ------------------ | -------------------- | --------------------------------- |
| Must Have          | 8                    | UC1-UC4, UC6-UC7, UC11-UC12, UC18 |
| Should Have        | 11                   | UC8-UC10, UC13-UC16, UC19         |
| Could Have         | 5                    | UC5, UC17, UC20-UC23              |
| Won't Have         | 1                    | UC24 (на будущее)        |

---

## Задание 2. Проектирование физической модели базы данных

### Описание

На основе логической модели из лабораторной работы №3 была разработана физическая модель базы данных с учетом особенностей PostgreSQL.

### Выполненные работы

1. **Уточнена логическая модель:**

   - Создана диаграмма в PlantUML (`logical-database-model.puml`)
   - Определены все атрибуты сущностей с типами данных
   - Указаны первичные и внешние ключи
   - Добавлены бизнес-правила и ограничения
2. **Разработана физическая модель для PostgreSQL:**

   - Создана ER-диаграмма (`physical-database-model.puml`)
   - Определены конкретные типы данных PostgreSQL
   - Добавлены индексы для оптимизации запросов
   - Указаны CHECK-ограничения для валидации данных
   - Определены политики каскадного удаления (ON DELETE)
3. **Создан SQL-скрипт для развертывания:**

   - Полный DDL-скрипт (`database-schema.sql`)
   - Установка необходимых расширений (uuid-ossp, pg_trgm)
   - Создание всех таблиц с ограничениями
   - Добавление индексов (B-tree, GIN)
   - Создание триггеров для автоматизации
   - Создание представлений (views)
   - Добавление начальных данных
   - Настройка Row Level Security (RLS)

### Структура базы данных

**Таблицы (18 шт.):**

- `users` - Пользователи системы
- `addresses` - Адреса доставки
- `categories` - Категории товаров (иерархия)
- `brands` - Бренды
- `products` - Товары
- `product_images` - Изображения товаров
- `product_characteristics` - Характеристики товаров
- `carts` - Корзины
- `cart_items` - Товары в корзине
- `orders` - Заказы
- `order_items` - Позиции заказа
- `payments` - Платежи
- `deliveries` - Доставки
- `reviews` - Отзывы
- `review_images` - Изображения к отзывам
- `review_helpfulness` - Оценки полезности отзывов
- `product_ratings` - Агрегированные рейтинги

**Индексы (40+ шт.):**

- Уникальные индексы для email, sku, slug
- B-tree индексы для внешних ключей
- GIN индексы для полнотекстового поиска
- Composite индексы для сложных запросов
- Partial индексы для оптимизации

**Триггеры (12 шт.):**

- Автоматическое обновление `updated_at`
- Автоматический пересчет рейтинга товара при изменении отзывов

**Представления (2 шт.):**

- `v_products_full` - Товары с полной информацией
- `v_orders_detailed` - Заказы с детальной информацией

### Ключевые решения

1. **Использование UUID вместо INTEGER:**

   - Лучше для распределенных систем
   - Защита от перебора ID
   - Уникальность без координации между серверами
2. **Полнотекстовый поиск:**

   - Расширение pg_trgm для триграммного поиска
   - GIN индексы на поля name и description
   - Поддержка нечеткого поиска
3. **JSONB для гибких данных:**

   - Адреса доставки в заказах
   - Распределение рейтингов
   - Гибкая структура без миграций
4. **Партиционирование (рекомендация):**

   - Таблица orders по дате создания (месячные партиции)
   - Таблица reviews по дате создания
5. **Безопасность:**

   - Row Level Security для users, orders, payments
   - CHECK-ограничения для валидации
   - Ограничения FOREIGN KEY с ON DELETE политиками

### Результаты

**Созданные файлы:**

- `diagrams/logical-database-model.puml` - Логическая модель
- `diagrams/physical-database-model.puml` - Физическая модель
- `database-schema.sql` - SQL DDL скрипт (800+ строк)

**Характеристики:**

- 18 таблиц
- 40+ индексов
- 12 триггеров
- 2 представления
- 3 RLS политики
- Полная поддержка ACID

---

## Задание 3. Проектирование маршрутов и конечных точек API

### Описание

Спроектированы RESTful API маршруты и конечные точки с сопоставлением Use Cases из лабораторной работы №3.

### Выполненные работы

1. **Определена структура API:**

   - Версионирование через URL: `/api/v1/`
   - JSON формат для всех запросов и ответов
   - JWT для аутентификации
   - HTTP статус коды согласно стандартам
2. **Спроектированы модули API:**

   - **Auth** - Аутентификация и авторизация (7 эндпоинтов)
   - **Users** - Управление профилем (8 эндпоинтов)
   - **Products** - Каталог товаров (8 эндпоинтов)
   - **Categories** - Категории (6 эндпоинтов)
   - **Brands** - Бренды (6 эндпоинтов)
   - **Cart** - Корзина (5 эндпоинтов)
   - **Orders** - Заказы (6 эндпоинтов)
   - **Reviews** - Отзывы (7 эндпоинтов)
   - **Compare** - Сравнение товаров (4 эндпоинта)
   - **Admin** - Администрирование (15+ эндпоинтов)
3. **Создана матрица сопоставления:**

   - Таблица Use Case → HTTP Method → Endpoint
   - Для каждого из 24 Use Cases определены конечные точки
   - Указаны права доступа для каждого эндпоинта
4. **Определены детали эндпоинтов:**

   - HTTP методы (GET, POST, PUT, DELETE)
   - Query параметры для фильтрации и пагинации
   - Request/Response форматы
   - Примеры запросов и ответов
   - Коды ошибок

### Архитектура API

**Принципы:**

- RESTful архитектура
- Stateless (без состояния на сервере)
- HATEOAS (ссылки на связанные ресурсы)
- Content Negotiation (поддержка JSON)
- Идемпотентность PUT и DELETE

**Аутентификация:**

- JWT Bearer токены
- Access token (1 час)
- Refresh token (30 дней)
- Заголовок: `Authorization: Bearer <token>`

**Роли и права доступа:**

| Роль | Эндпоинты                            |
| -------- | --------------------------------------------- |
| Guest    | GET /products, /categories, /brands, /reviews |
| Customer | Guest + /cart, /orders, POST /reviews         |
| Manager  | Customer + /admin/orders, /admin/reviews      |
| Admin    | Все эндпоинты                     |
| Courier  | /courier/deliveries                           |

**Rate Limiting:**

- Гости: 100 запросов / 15 минут
- Авторизованные: 1000 запросов / 15 минут
- Администраторы: без ограничений

### Примеры эндпоинтов

#### 1. Получение товаров с фильтрацией

```
GET /api/v1/products?category={uuid}&minPrice=10000&maxPrice=150000&inStock=true&sort=price_asc
```

#### 2. Поиск товаров

```
GET /api/v1/products/search?q=iPhone 15&page=1&limit=20
```

#### 3. Создание заказа

```
POST /api/v1/orders
Body: { deliveryAddress, deliveryMethod, paymentMethod, notes }
```

#### 4. Отслеживание заказа

```
GET /api/v1/orders/{id}
Response: { orderNumber, status, items, payment, delivery, statusHistory }
```

### Сопоставление с Use Cases

| Use Case | HTTP Метод | Конечная точка  | Доступ |
| -------- | --------------- | ---------------------------- | ------------ |
| UC1      | GET             | `/api/v1/products`         | Public       |
| UC2      | GET             | `/api/v1/products/search`  | Public       |
| UC3      | GET             | `/api/v1/products?filters` | Public       |
| UC4      | GET             | `/api/v1/products/:id`     | Public       |
| UC6      | POST            | `/api/v1/cart/items`       | Customer     |
| UC7      | POST            | `/api/v1/orders`           | Customer     |
| UC8      | GET             | `/api/v1/orders/:id`       | Customer     |
| UC11     | POST            | `/api/v1/auth/register`    | Public       |
| UC16     | POST            | `/api/v1/reviews`          | Customer     |
| UC18     | POST/PUT/DELETE | `/api/v1/products`         | Admin        |

### Результаты

**Созданные документы:**

- `api-routes-endpoints.md` - Полная документация API (70+ эндпоинтов)

**Характеристики:**

- 8 модулей API
- 70+ конечных точек
- 24 Use Cases покрыты API
- 5 ролей с разграничением доступа
- RESTful best practices

---

## Задание 4. Проектирование и тестирование API

### Описание

Создана полная спецификация OpenAPI 3.0 с примерами запросов и ответов для тестирования.

### Выполненные работы

1. **Создана OpenAPI 3.0 спецификация:**

   - Файл `openapi-specification.yaml`
   - Метаинформация API (название, версия, описание, контакты)
   - Определение 3 серверов (production, staging, local)
   - 9 тегов для группировки эндпоинтов
2. **Документированы эндпоинты:**

   - 15+ paths с полным описанием
   - HTTP методы, параметры, тела запросов
   - Схемы данных в components/schemas
   - Примеры запросов и ответов
   - HTTP статус коды и их описание
3. **Определены схемы данных (Schemas):**

   - User, Address
   - Product (Short и Full)
   - Category, Brand
   - Cart, CartItem
   - Order (Short и Full), OrderCreate
   - Review, ReviewCreate
   - Pagination, Error
   - Всего 15+ переиспользуемых схем
4. **Настроена аутентификация:**

   - Bearer JWT токены
   - Security scheme в OpenAPI
   - Указание требуемой аутентификации для каждого эндпоинта
5. **Определены стандартные ответы:**

   - 400 Bad Request
   - 401 Unauthorized
   - 403 Forbidden
   - 404 Not Found
   - Переиспользуемые через $ref
6. **Созданы примеры запросов:**

   - Документ `api-examples.md` с curl примерами
   - 15+ полных примеров запросов/ответов
   - Примеры для всех основных сценариев
   - Примеры ошибок всех типов

### Структура OpenAPI спецификации

```yaml
openapi: 3.0.3
info: {...}
servers: [...]
tags: [...]
paths:
  /auth/register: {...}
  /auth/login: {...}
  /users/me: {...}
  /products: {...}
  /cart: {...}
  /orders: {...}
  /reviews: {...}
components:
  securitySchemes: {...}
  schemas: {...}
  responses: {...}
```

### Примеры документированных эндпоинтов

#### 1. POST /auth/register

- Описание, operationId
- Request body schema
- Responses: 201, 400, 409
- Примеры запроса и ответа

#### 2. GET /products

- Query параметры (page, limit, category, brand, price, sort)
- Response schema с products, pagination, filters
- Примеры всех параметров

#### 3. POST /orders

- Security: bearerAuth
- Request body: OrderCreate schema
- Response: 201 с orderNumber, paymentUrl
- Error responses: 400, 401

### Тестирование API

**Методы тестирования:**

1. **Swagger UI:**

   - Интерактивная документация
   - Возможность тестирования прямо в браузере
   - URL: `https://api.technomart.com/docs`
2. **Postman:**

   - Импорт OpenAPI спецификации
   - Автоматическое создание коллекции
   - Сохранение переменных окружения (токены)
3. **cURL:**

   - Примеры команд в `api-examples.md`
   - Готовые к использованию запросы
   - Для всех основных сценариев

**Примеры cURL команд:**

```bash
# Регистрация
curl -X POST https://api.technomart.com/api/v1/auth/register \
  -H "Content-Type: application/json" \
  -d '{"email": "user@example.com", "password": "SecurePass123!", ...}'

# Получение товаров
curl -X GET "https://api.technomart.com/api/v1/products?page=1&limit=20"

# Добавление в корзину
curl -X POST https://api.technomart.com/api/v1/cart/items \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"productId": "uuid", "quantity": 1}'
```

### Mock Server

В спецификации предусмотрена возможность создания Mock Server для:

- Разработки фронтенда до готовности бекенда
- Тестирования интеграций
- Демонстрации API клиентам

**Инструменты:**

- SwaggerHub Auto-Mocking
- Prism Mock Server
- Postman Mock Server

### Результаты

**Созданные документы:**

- `openapi-specification.yaml` - Полная спецификация OpenAPI 3.0 (900+ строк)
- `api-examples.md` - Примеры запросов с cURL командами

**Характеристики:**

- OpenAPI 3.0.3
- 15+ задокументированных эндпоинтов
- 15+ переиспользуемых схем
- 15+ примеров запросов
- Готово к импорту в Swagger/Postman

---

## Общие результаты работы

### Созданные артефакты

**Документы:**

1. `requirements-model.md` - Модель требований (Актер → User Story → Use Case)
2. `use-case-registry.md` - Реестр вариантов использования
3. `api-routes-endpoints.md` - Документация API маршрутов
4. `api-examples.md` - Примеры API запросов

**Диаграммы:**

1. `diagrams/logical-database-model.puml` - Логическая модель БД
2. `diagrams/physical-database-model.puml` - Физическая модель БД

**Код:**

1. `database-schema.sql` - DDL скрипт PostgreSQL (800+ строк)
2. `openapi-specification.yaml` - OpenAPI 3.0 спецификация (900+ строк)

### Структура проекта lab4

```
lab4/
├── diagrams/
│   ├── logical-database-model.puml
│   └── physical-database-model.puml
├── requirements-model.md
├── use-case-registry.md
├── api-routes-endpoints.md
├── api-examples.md
├── database-schema.sql
├── openapi-specification.yaml
└── lab4-report.md
```

### Статистика

| Артефакт            | Объем                                  |
| --------------------------- | ------------------------------------------- |
| Документы MD       | 6 файлов, ~3500 строк            |
| Диаграммы PlantUML | 2 файла, ~400 строк               |
| SQL скрипт            | 1 файл, 800+ строк                 |
| OpenAPI spec                | 1 файл, 900+ строк                 |
| **ИТОГО**        | **10 файлов, ~5600 строк** |

### Охват требований

| Элемент                  | Количество   |
| ------------------------------- | ---------------------- |
| Действующие лица | 5                      |
| User Stories                    | 21                     |
| Use Cases                       | 24                     |
| Таблицы БД             | 18                     |
| API эндпоинты          | 70+                    |
| HTTP методы               | GET, POST, PUT, DELETE |
| Роли доступа         | 5                      |

---

## Ключевые технические решения

### 1. Архитектура API

**RESTful принципы:**

- Ресурс-ориентированный подход
- Использование HTTP методов по назначению
- Stateless архитектура
- Единообразие интерфейсов

**Безопасность:**

- JWT токены для аутентификации
- Role-Based Access Control (RBAC)
- Rate Limiting для защиты от DDoS
- HTTPS для всех соединений

### 2. База данных

**PostgreSQL преимущества:**

- ACID транзакции
- Сложные типы данных (JSONB, UUID)
- Полнотекстовый поиск
- Row Level Security
- Богатая экосистема расширений

**Оптимизация:**

- Индексы B-tree для внешних ключей
- GIN индексы для полнотекстового поиска
- Partial индексы для фильтрации
- Триггеры для автоматизации

### 3. Документирование

**OpenAPI 3.0 преимущества:**

- Стандарт индустрии
- Автоматическая генерация клиентов
- Интерактивная документация (Swagger UI)
- Валидация запросов/ответов
- Mock servers

### 4. Масштабируемость

**Подходы:**

- Версионирование API через URL
- Пагинация для больших выборок
- Фильтрация и сортировка на стороне сервера
- Кэширование с Redis (планируется)
- CDN для статики (планируется)

---

## Соответствие требованиям задания

### Задание 1 ✅

- [X] Изучена статья "Проектирование REST API"
- [X] Описаны требования в формате Актер → User Story → Use Case
- [X] Создан реестр вариантов использования
- [X] Модель и реестр добавлены в документацию

### Задание 2 ✅

- [X] Уточнена логическая модель БД в виде ER-диаграммы
- [X] Разработана физическая модель для PostgreSQL
- [X] Создан SQL-файл с DDL
- [X] Добавлены индексы и триггеры
- [X] Модели добавлены в документацию

### Задание 3 ✅

- [X] Спроектированы маршруты и конечные точки
- [X] Сопоставлены Use Cases с эндпоинтами
- [X] Определены HTTP методы для каждого маршрута
- [X] Описание добавлено в документацию

### Задание 4 ✅

- [X] Изучены примеры Swagger Petstore
- [X] Создана спецификация OpenAPI 3.0
- [X] Определены тела POST/PUT запросов
- [X] Указаны HTTP статусы и их смысл
- [X] Добавлены примеры запросов
- [X] Готово к тестированию в Swagger/Postman

### Задание 5 (частично) ⚠️

Для группы 12-13 требуется дополнительно:

- [ ] Создать структуру репозиториев
- [ ] Настроить CI/CD
- [ ] Развернуть Docker окружение
- [ ] Настроить SonarQube
- [ ] Развернуть на облачной платформе

*Эти задачи требуют практической реализации и выходят за рамки проектирования.*

---

## Практическая ценность

### Для разработки

1. **Backend разработчики:**

   - SQL скрипт для быстрого развертывания БД
   - OpenAPI spec для генерации серверного кода
   - Четкое понимание API контрактов
2. **Frontend разработчики:**

   - OpenAPI spec для генерации клиентов
   - Swagger UI для тестирования
   - Примеры всех запросов
3. **QA инженеры:**

   - Use Case сценарии для тест-кейсов
   - Примеры API запросов для автотестов
   - Критерии приемки для каждого требования
4. **DevOps:**

   - SQL скрипт для автоматизации развертывания
   - Документация для настройки окружения

### Для бизнеса

1. **Продуктовые менеджеры:**

   - User Stories для планирования спринтов
   - Приоритизация MoSCoW
   - Оценка объема работ
2. **Архитекторы:**

   - Полная документация API
   - Модели данных для интеграций
   - Масштабируемая архитектура

---

## Выводы

В ходе выполнения лабораторной работы №4 были успешно реализованы все основные задания:

1. **Модель требований** обеспечивает полное понимание потребностей всех заинтересованных сторон через User Stories и их связь с Use Cases.
2. **Физическая модель базы данных** готова к развертыванию на PostgreSQL и оптимизирована для высокой производительности с помощью правильных индексов и триггеров.
3. **API маршруты** спроектированы согласно RESTful best practices с полным сопоставлением Use Cases, что обеспечивает покрытие всех функциональных требований.
4. **OpenAPI спецификация** предоставляет стандартизированную документацию API, готовую для генерации кода, тестирования и интеграции.

Все созданные артефакты образуют полный комплект технической документации для начала разработки интернет-магазина ТехноМарт.

### Приобретенные навыки

- ✅ Проектирование требований через User Stories
- ✅ Создание физических моделей БД для PostgreSQL
- ✅ Проектирование RESTful API
- ✅ Документирование API в формате OpenAPI 3.0
- ✅ Написание DDL скриптов с триггерами и индексами
- ✅ Сопоставление Use Cases с API эндпоинтами

### Следующие шаги

1. Создание Mock Server для тестирования фронтенда
2. Настройка CI/CD pipeline
3. Разработка Docker Compose для локальной разработки
4. Реализация бекенд API на Node.js/Python/Java
5. Разработка фронтенд приложения (веб и мобильное)
6. Интеграция с платежными системами и службами доставки
